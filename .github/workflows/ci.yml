name: CI
on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
jobs:
  test_analyze:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: stable
        if: ${{ hashFiles('**/pubspec.yaml') != '' }}
      - run: flutter pub get
        if: ${{ hashFiles('**/pubspec.yaml') != '' }}
      - run: flutter analyze
        if: ${{ hashFiles('**/pubspec.yaml') != '' }}
      - run: flutter test
        if: ${{ hashFiles('**/pubspec.yaml') != '' }}
  security_scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: aquasecurity/trivy-action@0.20.0
        with:
          scan-type: fs
          ignore-unfixed: true
          format: table
          exit-code: 0
          scan-ref: .
  build_and_push_image:
    needs: [test_analyze, security_scan]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - uses: docker/build-push-action@v5
        with:
          context: .
          file: Habit_Tracker_Application/Dockerfile
          push: true
          tags: ghcr.io/${{ github.repository_owner }}/habit-tracker:latest
  notify:
    needs: [build_and_push_image]
    runs-on: ubuntu-latest
    steps:
      - name: Job summary
        run: |
          echo "CI completed for $GITHUB_SHA" >> $GITHUB_STEP_SUMMARY
          echo "Docker image pushed to ghcr.io/${{ github.repository_owner }}/habit-tracker:latest" >> $GITHUB_STEP_SUMMARY
  deploy:
    needs: build_and_push_image
    runs-on: ubuntu-latest
    steps:
      - run: echo "Deploy step placeholder; use infra to pull ghcr image"
